---
- name: 'security | sshd | check available moduli size'
  ansible.builtin.shell: >
    awk '$5 < {{ sshd_moduli_minsize }}' '{{ sshd_moduli_file }}'
  when:
  - sshd_moduli_minsize is defined
  register: sshd_moduli_minsize_check
  changed_when: sshd_moduli_minsize_check.stdout
  check_mode: false

- name: 'security | sshd | delete small moduli'
  ansible.builtin.shell: >
    awk '$5 >= {{ sshd_moduli_minsize }}' '{{ sshd_moduli_file }}' > '{{ sshd_moduli_file }}.ansible' ;
    [ -r '{{ sshd_moduli_file }}.ansible' -a -s '{{ sshd_moduli_file }}.ansible' ] && mv '{{ sshd_moduli_file }}.ansible' '{{ sshd_moduli_file }}' || rm '{{ sshd_moduli_file }}.ansible'
  notify:
  - 'security | sshd | validate conf and restart service'
  when:
  - sshd_moduli_minsize_check.stdout
  changed_when: true

- name: 'security | sshd | ensure key revocation list exists (to avoid lock-out)'
  ansible.builtin.copy:
    dest: '{{ sshd_key_revocation_list_file }}'
    content: ''
    owner: 'root'
    group: 'root'
    mode: '0600'
    force: false
  notify:
  - 'security | sshd | validate conf and reload service'
  when:
  - sshd_key_revocation_list_file is defined

- name: 'security | sshd | create or update key revocation list'
  ansible.builtin.template:
    dest: '{{ sshd_key_revocation_list_file }}'
    src: '{{ sshd_key_revocation_list_template }}'
    owner: 'root'
    group: 'root'
    mode: '0600'
  notify:
  - 'security | sshd | validate conf and reload service'
  when:
  - sshd_key_revocation_list_template is defined

- name: 'security | sshd | create or update issue file'
  ansible.builtin.template:
    dest: '{{ sshd_issue_file | d("/etc/issue.net") }}'
    src: '{{ sshd_issue_template }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
  when:
  - sshd_issue_template is defined

- name: 'security | sshd | delete conf.d configuration file'
  ansible.builtin.file:
    dest: '{{ item.dest | mandatory | havlasme.security.abspath(sshd_conf_d) }}'
    state: 'absent'
  loop: '{{ sshd_conf | selectattr("state", "havlasme.security.is_absent") | list }}'
  loop_control:
    label: '{{ item.dest | mandatory }}'
  notify:
  - 'security | sshd | validate conf and reload service'

- name: 'security | sshd | create or update conf.d configuration file'
  ansible.builtin.template:
    dest: '{{ item.dest | mandatory | havlasme.security.abspath(sshd_conf_d) }}'
    src: '{{ item.src | d(sshd_conf_template) }}'
    owner: 'root'
    group: 'root'
    mode: '0644'
    validate: sshd -t -f %s
  loop: '{{ sshd_conf | selectattr("state", "havlasme.security.is_present") | list }}'
  loop_control:
    label: '{{ item.dest | mandatory }}'
  notify:
  - 'security | sshd | validate conf and reload service'
